# ----------------------------------------------------------------------------
# GitHub Actions workflow to test auto-generated stuff in demo-models
# is still up-to-date.
# ----------------------------------------------------------------------------

name: Test Auto-Generated Stuff is Up-To-Date
on:
  pull_request:
  push:
  # React to cge-docker-unstable-changed, dispatched from castle-engine-docker
  repository_dispatch:
    types: [cge-docker-unstable-changed]

defaults:
  run:
    shell: bash

jobs:
  test_auto_generated:
    runs-on: ubuntu-latest
    container: kambi/castle-engine-cloud-builds-tools:cge-unstable
    steps:
    - uses: actions/checkout@v6

    - name: Checkout castle-model-viewer (with castle-model-converter)
      uses: actions/checkout@v6
      with:
        repository: castle-engine/castle-model-viewer
        path: castle-model-viewer

    - name: Build castle-model-converter
      run: |
        cd castle-model-viewer/
        castle-engine compile --mode=debug --manifest-name=CastleEngineManifest.converter.xml

    - name: Put castle-model-converter on $PATH
      run: echo "PATH=${PATH}:${GITHUB_WORKSPACE}/castle-model-viewer/" >> $GITHUB_ENV

    - name: Regenerate auto-generated stuff
      run: |
        make clean
        make all

    # Test everything looks clean, according to git diff.
    #
    # We need to add dir to safe.directory, otherwise "git diff" refuses with message
    # "warning: Not a git repository" (unsure why; actions/checkout didn't use
    # any special user to do the checkout, from what we know).
    - name: Compare auto-generated stuff with last committed
      run: |
        git config --global --add safe.directory "${GITHUB_WORKSPACE}"
        git diff --exit-code
